# Auto-Code Model

[Back](../README.md#api-documentation)

## Overview

MATLAB supports the creation of executables from simulations which
increases execution speed, enables parallel execution without requiring
multiple licenses, and can improve code distribution. Static libraries can
also be created. However, this process introduces additional complexity into the
simulation environment and imposes certain limitations on what can be
utilized within these simulations.

See [examples/BatchProcessing](examples/BatchProcessing/README.md) for a
detailed example workflow for Windows and Unix.

Another short example of performing batch processing in Windows is provided
in [examples/exampleBAMbatch.bat](examples/exampleBAMbatch.bat).


## Key Features

1. **Build Functions and Scripts**  Several build functions and scripts are provided to automatically create an executable or library from the main Simulink diagram. They have several quality of life features such as building in a clean MATLAB instance.
2. **Custom Parameter Updates** The `SimPar` structure was created to capture the tunable parameters in the simulation. With the custom interface to the executable, new `SimPar` values can be sent to an existing executable.
3. **Data Processing** The bus structure information defined in the base simulation is used to parse the output of the executables, taking a large output timeseries and converting it to a MATLAB structure with the correct names and signal sizes.


## Key Functions

### Building without ROS2 dependencies

#### `build.m`
Core function that handles all the Simulink configuration needed to compile an executable if no ROS2 dependencies exist. Compiles the executable or the library. Resets Simulink to default configuration. Called by `buildExe.m` and `buildLib.m` respectively.
#### `buildExe.m`
This wrapper script builds an executable from the information (`model_name`, `SimIn`, `SimPar`, buses) defined in the MATLAB workspace.
#### `buildLib.m`
This wrapper script builds a static library from the information (`model_name`, `SimIn`, `SimPar`, buses) defined in the MATLAB workspace.

### Building with ROS2 dependencies

#### `buildWithRos.m`
Core function that handles all the Simulink configuration needed to compile an executable that has ROS2 dependencies. Compiles the executable or the library. Resets Simulink to default configuration. Called by `buildExeRos.m` and `buildLibRos.m` respectively.  This function is based on the `build.m` function and its capabilities will likely be formally incorporated into it during a future release.
#### `buildExeRos.m`
This wrapper script builds an executable that has ROS2 dependencies from the information (`model_name`, `SimIn`, `SimPar`, buses) defined in the MATLAB workspace.  It makes use of a user-specified array of strings that specify which ROS2 packages are required.  Default values are set based on known variant definitions, if the `rosPackages` variable does not exist.
#### `buildLibRos.m`
This wrapper script builds a static library that has ROS2 dependencies from the information (`model_name`, `SimIn`, `SimPar`, buses) defined in the MATLAB workspace.  It makes use of a user-specified array of strings that specify which ROS2 packages are required.  Default values are set if the `rosPackages` variable does not exist.
### Utilities
#### `writePfile.m`
Writes a binary file containing all the information in `SimPar.Value`. This file is then read by the executable and used to update the tunable parameters of the simulation executable.
#### `convertArrayToStruct.m`
Loads the .mat file generated by running the executable and parses the data according to the signal definition in `BUS_USER_SIM_OUT`.

## Getting Started Guide

### Prerequisites

- Install MATLAB on your system.
- Ensure required toolboxes for Simulink code generation (e.g., Simulink Coder) are available.
- Verify an active MATLAB license that supports code generation.

### Step-by-Step Instructions

#### 1. Check Compiler Setup

Ensure the MEX compiler is set up:

```matlab
mex -setup
```

Select or verify your C/C++ compiler configuration in MATLAB.


#### 2. Run Setup Script

Run setup script.

```matlab
setup;  
```

or example script, such as `example_defaults.m` with desired `userStruct` modifications.

#### 3. Building without ROS2 dependencies

Capabilities were developed for performing code generation on a Simulink model file that does not have any dependencies on ROS2 packages.  These functions and scripts allow the user to generate either an executable or a static library which can be integrated with a third-party application.

##### a. Build an Executable

Generate an executable using the `buildExe.m` script:

```matlab
buildExe;
```

This compiles the Simulink model into an executable file directly from your current workspace.

##### b. Build a Static Library

Generate a static library using the `buildLib.m` script:

```matlab
buildLib;
```

This compiles the Simulink model into a static library file directly from your current workspace.

Significant knowledge on how to utilize a library generated from a Simulink model by a third-party application is required.  For the current implementation, it is left to the user on identifying the needed header files and/or developing a potential interface wrapper library that contains any knowledge of MATLAB-specific headers in it, preventing the need of the third-party application to have that knowledge.

##### c. Building an Executable or Static Library in a separate MATLAB shell

In the root directory, `sim_build.m` is a convenience function which can be used
to generate either an executable or a static library in a separate MATLAB shell,
making use of the `buildExe.m` and `buildLib.m` scripts, respectively.
`sim_build.m` can help manage MATLAB toolbox license usage during the build
process, and is useful for isolating your build and development environments.

_`sim_build.m` currently only supports building Simulink models without ROS2
dependencies._

For detailed usage information, see the `sim_build` documentation. Here are
several simple use cases.

Generate an executable using the default `setup` script and MATLAB license:

```matlab
systemCmd = sim_build();
```

Note that `sim_build.m` returns a `systemCmd` string which is passed to MATLAB's
`system` function (which in turn calls the system shell). If the build fails,
this may be useful for debugging the process, or simply be used to modify the
command and run manually from a shell.

Generate an executable using a user-specified setup script, `userSetup.m`:

```matlab
setupScript = 'userSetup' % user setup script name without file extension
sim_build(setupScript=setupScript)
```

Generate an executable using a specific MATLAB license file:

```matlab
licensePath = '/path/to/my/license';  % Path to the license file to use
sim_build(licensePath=licensePath);
```

Generate a static library:

```matlab
sim_build(buildTarget='library');
```

This compiles the Simulink model into a static library file in a temporary
workspace using the specified setup function. The static library allows the
model to be called from a third-party application, on a frame-by-frame basis.

#### 4. Building with ROS2 dependencies

The core capabilities of building an executable or static library from a
Simulink model were expanded to support ROS2 dependencies. New functions and
scripts, `buildWithRos.m` `buildExeRos.m` `buildLibRos.m`, were developed based
on the original ones described above. In the future, these may be fully
integrated into the original functions and scripts.

To build with ROS2 dependencies, make sure that you start MATLAB from an
environment which has access to `colcon` build tools. To check this, run
```matlab
!colcon -h
```
Also make sure that your setup script specifies the desired publisher and 
subscriber types. For more information, see the
[ROS2_ws README](../ROS2_ws/README.md). 

##### a. Build an Executable

Generate an executable using `buildExeRos.m` script:

```matlab
buildExeRos;
```

This compiles the Simulink model into an executable file directly from your current workspace.

##### b. Build a Static Library

Generate a static library using `buildLibRos.m` script:

```matlab
buildLibRos;
```

This compiles the Simulink model into a static library file directly from your current workspace.

Significant knowledge on how to utilize a library generated from a Simulink model by a third-party application is required.  For the current implementation, it is left to the user on identifying the needed header files and/or developing a potential interface wrapper library that contains any knowledge of MATLAB-specific headers in it, preventing the need of the third-party application to have that knowledge.

#### 5. Locate the Build Target

##### a. Without ROS2 dependencies

Find the generated target under:

```
AutoCode/{ModelName}_{BuildType}/
```

where `BuildType` is either `app` for an executable or `lib` for a static
library. For example:

- (Windows) `AutoCode/BAM_app/BAM_app.exe`
- (Unix) `AutoCode/BAM_app/BAM_app`

##### b. With ROS2 dependencies

Find the generated target under:

```
AutoCodeRos/{ModelName}_{BuildType}/
```

where `BuildType` is either `app` for an executable or `lib` for a static library

Since the `colcon` tool is used when building with ROS2 dependencies, the 
resulting binary is located under the default folders created by it:
- (Windows) `AutoCodeRos/BAM_app/install/bin/BAM_app.exe`
- (Unix) `AutoCodeRos/BAM_app/install/bin/BAM_app`

#### 6. Run the Executable with a Parameter File

If you want to run an BAM executable, it is necessary to generate a binary file from the SimPar object, and then provide that binary file as a command line argument to the executable.

For an example of this see [executable example](./examples/BatchProcessing/README.md).  

In general, the process is to first use the `writePfile` utility to save a binary file of the modifiable
parameters in the `SimPar` Simulink parameter object:

```matlab
writePfile(SimPar.Value,'pFile01.bin')
```

Note that `SimIn` parameters are hardcoded in the executable at build time.
Any parameter that a user wishes to change at runtime must be specified as
`SimPar`, AND that `SimPar` parameter must be used in the `BAM.slx` model
appropriately prior to building the executable.

Now execute the program with the saved parameters and a specified output
file, `out01.mat`. On Windows:

```matlab
! .\AutoCode\BAM_app\BAM_app.exe < pFile01.bin out01.mat
```

On Unix:

```matlab
! ./AutoCode/BAM_app/BAM_app < pFile01.bin out01.mat
```

The parameter binary file is piped to the executable, which after execution
stores the user defined `SimOut` variable in `out01.mat`. Note that the
user-specified `SimOut` structure (see `User Signal Logging` block) at
build time dictates what data is written.

#### 7. Load Data and Convert Output Data to Structure

Convert vector data into a structured format using `convertArrayToStruct`:

```matlab
data = convertArrayToStruct('out01.mat');
```

This organizes output data based on predefined bus definitions.

[Back](../README.md#api-documentation)